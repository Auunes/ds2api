name: Build and Push Docker Image

on:
  push:
    branches: [main]  # 仅在推送到main分支时触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # 授予写入GHCR包的权限
      contents: read   # 授予读取仓库内容的权限

    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # 拉取仓库代码

      - name: Login to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}  # 当前触发Action的用户
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动生成的令牌

      # 处理用户名大小写问题（GHCR要求仓库所有者名小写）
      - name: Set lowercase repository owner
        id: vars
        run: echo "username=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      # 构建并推送Docker镜像到GHCR
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .  # 构建上下文为仓库根目录（需确保根目录有Dockerfile）
          push: true  # 启用推送镜像
          # 镜像标签：适配ds2api仓库，使用小写用户名+仓库名+latest标签
          tags: ghcr.io/${{ steps.vars.outputs.username }}/ds2api:latest
          # 可选：启用构建缓存加速构建（按需开启）
          cache-from: type=gha
          cache-to: type=gha,mode=max
